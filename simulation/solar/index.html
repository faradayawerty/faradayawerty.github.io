
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Solar System Simulation</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
            background-color: #000; /* Black background for space */
            cursor: default; /* Default cursor */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            /* Prevent text selection on touch devices */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Prevent zooming via double-tap on iOS/Android (handled by our script) */
            touch-action: none;
        }

        canvas {
            display: block; /* Remove extra space below canvas */
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 200; /* Ensure controls are above other elements */
        }

        /* Styles for control toggle buttons */
        #controlToggleButtons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 210; /* Ensure toggle buttons are on top */
            display: flex;
            gap: 10px; /* Space between buttons */
        }

        #controlToggleButtons button {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        #controlToggleButtons button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Hide controls by default on smaller screens and show/hide via JS */
        @media (max-width: 768px) {
            #controls {
                display: none; /* Hidden by default on mobile */
            }
            #showControlsBtn {
                display: block; /* Show "Show Controls" button on mobile */
            }
            #hideControlsBtn {
                display: none; /* Hide "Hide Controls" button initially */
            }
        }

        /* Default desktop state */
        @media (min-width: 769px) {
            #controls {
                display: flex; /* Always visible on desktop */
            }
            #showControlsBtn, #hideControlsBtn {
                display: none; /* Hide toggle buttons on desktop */
            }
        }

        #controls div {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        #controls label {
            margin-right: 5px;
            font-weight: bold;
        }

        #controls button {
            border: none;
            color: white;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        /* Default button styles, overridden by specific classes/inline styles */
        #controls button:not(.speed-button):not(.radius-button) {
            filter: brightness(0.9); /* Slightly darker default for contrast */
        }

        #controls button:hover:not(.speed-button):not(.radius-button) {
            filter: brightness(1.2); /* Slight brightness increase on hover */
        }

        #controls button.speed-button {
            background-color: #008CBA; /* Blue */
        }

        #controls button.speed-button:hover {
            background-color: #007bb5;
        }

        /* Styles for radius buttons based on the body type they control */
        #controls button.radius-sun {
            background-color: #DAA520; /* Goldenrod for Sun radius buttons */
        }
        #controls button.radius-sun:hover {
            background-color: #c7951e;
        }

        #controls button.radius-terrestrial {
            background-color: #F4A460; /* SandyBrown for terrestrial planet radius buttons */
        }
        #controls button.radius-terrestrial:hover {
            background-color: #e0924e;
        }

        #controls button.radius-gas-giant {
            background-color: #6A5ACD; /* SlateBlue for gas giant radius buttons */
        }
        #controls button.radius-gas-giant:hover {
            background-color: #5d4aae;
        }

        #currentSpeedDisplay,
        #currentSunVisualRadiusScale,
        #currentTerrestrialVisualRadiusScale,
        #currentGasGiantVisualRadiusScale {
            margin-left: 10px;
            font-weight: bold;
            color: #FFD700; /* Gold color for visibility */
        }

        #infoDisplay {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none; /* Hidden by default */
            pointer-events: none; /* Allow mouse events to pass through */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            white-space: nowrap; /* Prevent text wrapping */
            z-index: 100; /* Ensure it's above other elements */
        }

        /* New Planet Menu Styles */
        #newPlanetMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7); /* Cyan glow */
            z-index: 300; /* Above all other elements */
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 15px;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 90%; /* Responsive width */
            max-height: 90%; /* Responsive height */
            overflow-y: auto; /* Scroll if content overflows */
        }

        #newPlanetMenu h2 {
            text-align: center;
            color: #00FFFF; /* Cyan */
            margin-bottom: 15px;
        }

        #newPlanetMenu div {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #newPlanetMenu label {
            font-weight: bold;
            color: #A0EEFF; /* Light Cyan */
        }

        #newPlanetMenu input[type="text"],
        #newPlanetMenu input[type="number"],
        #newPlanetMenu select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #00FFFF;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        /* Style for color input to make it larger */
        #newPlanetMenu input[type="color"] {
            height: 40px; /* Make color input taller */
            padding: 2px; /* Adjust padding for better appearance */
        }

        /* Ensure select options are visible */
        #newPlanetMenu select option {
            background-color: #222; /* Darker background for options */
            color: black; /* Black text for options */
        }

        #newPlanetMenu input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #00FFFF;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        #newPlanetMenu input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00FFFF;
            cursor: pointer;
            border: 2px solid white;
        }

        #newPlanetMenu input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00FFFF;
            cursor: pointer;
            border: 2px solid white;
        }

        #newPlanetMenu .button-group {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        #newPlanetMenu button {
            background-color: #00FFFF; /* Cyan */
            color: #000; /* Black text on cyan */
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        #newPlanetMenu button:hover {
            background-color: #33FFFF; /* Lighter Cyan */
            transform: translateY(-2px);
        }

        #newPlanetMenu button#cancelNewPlanetBtn {
            background-color: #FF4500; /* OrangeRed */
        }

        #newPlanetMenu button#cancelNewPlanetBtn:hover {
            background-color: #FF6347; /* Tomato */
        }

        /* Style for the smaller "Add New Planet" button */
        #addNewPlanetBtn {
            padding: 5px 8px; /* Even smaller padding */
            font-size: 10px; /* Even smaller font size */
        }

        /* Styles for planet selection buttons and their delete buttons */
        .planet-button-container {
            display: flex;
            align-items: center;
            gap: 3px; /* Space between planet button and delete button */
        }

        .delete-planet-btn {
            background-color: #dc3545; /* Red for delete */
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1; /* Adjust line height for better appearance */
            transition: background-color 0.3s ease;
            margin-left: 5px; /* space from the planet name button */
        }

        .delete-planet-btn:hover {
            background-color: #c82333;
        }

    </style>
</head>
<body>
    <canvas id="solarSystemCanvas"></canvas>
    <div id="infoDisplay"></div>

    <div id="controlToggleButtons">
        <button id="showControlsBtn">Show Controls</button>
        <button id="hideControlsBtn">Hide Controls</button>
    </div>

    <div id="controls">
        <div>
            <label>Center On:</label>
            <div id="planetSelectionButtons"></div>
        </div>
        <div>
            <label>Simulation Speed:</label>
            <button id="slowDownBtn" class="speed-button">Slow Down</button>
            <button id="speedUpBtn" class="speed-button">Speed Up</button>
            <span id="currentSpeedDisplay">Speed: 1x</span>
        </div>
        <hr style="border-color: #555; width: 90%;"> <div>
            <label>Sun Visual Size:</label>
            <button id="decreaseSunRadiusBtn" class="radius-sun">Smaller</button>
            <button id="increaseSunRadiusBtn" class="radius-sun">Bigger</button>
            <span id="currentSunVisualRadiusScale">Scale: 1x</span>
        </div>
        <div>
            <label>Terrestrial Visual Size:</label>
            <button id="decreaseTerrestrialRadiusBtn" class="radius-terrestrial">Smaller</button>
            <button id="increaseTerrestrialRadiusBtn" class="radius-terrestrial">Bigger</button>
            <span id="currentTerrestrialVisualRadiusScale">Scale: 1x</span>
        </div>
        <div>
            <label>Gas Giant Visual Size:</label>
            <button id="decreaseGasGiantRadiusBtn" class="radius-gas-giant">Smaller</button>
            <button id="increaseGasGiantRadiusBtn" class="radius-gas-giant">Bigger</button>
            <span id="currentGasGiantVisualRadiusScale">Scale: 1x</span>
        </div>
        <hr style="border-color: #555; width: 90%;">
        <button id="addNewPlanetBtn" style="background-color: #28a745; margin-top: 10px;">Add New Planet</button>
    </div>

    <div id="newPlanetMenu">
        <h2>Create New Planet</h2>
        <div>
            <label for="planetName">Name:</label>
            <input type="text" id="planetName" value="New Planet">
        </div>
        <div>
            <label for="planetRadius">Radius (km):</label>
            <input type="number" id="planetRadius" value="6000" min="100" max="1000000">
        </div>
        <div>
            <label for="planetMass">Mass (x10^24 kg):</label>
            <input type="number" id="planetMass" value="5.972" step="0.01" min="0.01" max="10000">
        </div>
        <div>
            <label for="planetColor">Color:</label>
            <input type="color" id="planetColor" value="#FFFFFF">
        </div>
        <div>
            <label for="initialVelocityMagnitude">Initial Velocity Magnitude (km/s):</label>
            <input type="number" id="initialVelocityMagnitude" value="29.78" step="0.1" min="0">
        </div>
        <div>
            <label for="initialVelocityAngle">Initial Velocity Angle (degrees relative to horizontal):</label>
            <input type="number" id="initialVelocityAngle" value="90" step="1" min="0" max="360">
        </div>
        <div>
            <label for="planetType">Planet Type:</label>
            <select id="planetType">
                <option value="terrestrial">Terrestrial</option>
                <option value="gas_giant">Gas Giant</option>
            </select>
        </div>
        <div class="button-group">
            <button id="createPlanetConfirmBtn">OK</button>
            <button id="cancelNewPlanetBtn">Cancel</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('solarSystemCanvas');
        const ctx = canvas.getContext('2d');
        const infoDisplay = document.getElementById('infoDisplay');
        const planetSelectionButtonsContainer = document.getElementById('planetSelectionButtons');
        const slowDownBtn = document.getElementById('slowDownBtn');
        const speedUpBtn = document.getElementById('speedUpBtn');
        const currentSpeedDisplay = document.getElementById('currentSpeedDisplay');

        const decreaseSunRadiusBtn = document.getElementById('decreaseSunRadiusBtn');
        const increaseSunRadiusBtn = document.getElementById('increaseSunRadiusBtn');
        const currentSunVisualRadiusScale = document.getElementById('currentSunVisualRadiusScale');

        const decreaseTerrestrialRadiusBtn = document.getElementById('decreaseTerrestrialRadiusBtn');
        const increaseTerrestrialRadiusBtn = document.getElementById('increaseTerrestrialRadiusBtn');
        const currentTerrestrialVisualRadiusScale = document.getElementById('currentTerrestrialVisualRadiusScale');

        const decreaseGasGiantRadiusBtn = document.getElementById('decreaseGasGiantRadiusBtn');
        const increaseGasGiantRadiusBtn = document.getElementById('increaseGasGiantRadiusBtn');
        const currentGasGiantVisualRadiusScale = document.getElementById('currentGasGiantVisualRadiusScale');

        // New control toggle elements
        const controlsPanel = document.getElementById('controls');
        const showControlsBtn = document.getElementById('showControlsBtn');
        const hideControlsBtn = document.getElementById('hideControlsBtn');

        // New Planet Menu Elements
        const addNewPlanetBtn = document.getElementById('addNewPlanetBtn');
        const newPlanetMenu = document.getElementById('newPlanetMenu');
        const planetNameInput = document.getElementById('planetName');
        const planetRadiusInput = document.getElementById('planetRadius');
        const planetMassInput = document.getElementById('planetMass');
        const planetColorInput = document.getElementById('planetColor');
        const initialVelocityMagnitudeInput = document.getElementById('initialVelocityMagnitude');
        const initialVelocityAngleInput = document.getElementById('initialVelocityAngle');
        const planetTypeSelect = document.getElementById('planetType');
        const createPlanetConfirmBtn = document.getElementById('createPlanetConfirmBtn');
        const cancelNewPlanetBtn = document.getElementById('cancelNewPlanetBtn');

        let isCreatingNewPlanet = false;
        let newPlanetData = null;


        // Set canvas dimensions
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- Simulation Constants ---
        const G = 6.6743e-11; // Gravitational constant (m^3 kg^-1 s^-2)
        const AU_TO_KM = 149.6e6; // 1 AU in kilometers
        let KM_TO_PIXELS_SCALE = 20e-7;

        let SUN_VISUAL_RADIUS_FACTOR = 1;
        let TERRESTRIAL_VISUAL_RADIUS_FACTOR = 1;
        let GAS_GIANT_VISUAL_RADIUS_FACTOR = 1;

        let TIME_STEP = 3600 * 24; // One Earth day in seconds for simulation step

        // Define Sun's mass explicitly as a constant (kg)
        const SUN_MASS = 1.989e30;

        // Orbit trail settings
        const ORBIT_TRAIL_LENGTH = 1000;
        const ORBIT_TRAIL_ALPHA = 0.6;
        const ORBIT_TRAIL_WIDTH = 1.5;

        // --- Camera/Viewport Variables ---
        let cameraX = 0;
        let cameraY = 0;
        let zoom = 1;
        const MAX_ZOOM = 1000;
        let centerBody = null;

        // --- Touch Event Variables ---
        let isDragging = false;
        let lastTouchX = 0;
        let lastTouchY = 0;
        let initialPinchDistance = 0;
        let lastTapTime = 0;
        const DOUBLE_TAP_TIME = 300; // milliseconds
        const DRAG_THRESHOLD = 5; // pixels, to differentiate tap from drag


        // --- Celestial Body Class ---
        class CelestialBody {
            constructor(name, baseRadiusKM, massKG, color, orbitalRadiusAU, periodDays, initialAngle = 0, type = 'planet') {
                this.name = name;
                this.baseRadius = baseRadiusKM;
                this.mass = massKG;
                this.color = color;
                this.orbitalRadius = orbitalRadiusAU * AU_TO_KM;

                this.x = Math.cos(initialAngle) * this.orbitalRadius;
                this.y = Math.sin(initialAngle) * this.orbitalRadius;

                if (orbitalRadiusAU > 0) {
                    const v = Math.sqrt(G * SUN_MASS / (this.orbitalRadius * 1000));
                    this.vx = -Math.sin(initialAngle) * v;
                    this.vy = Math.cos(initialAngle) * v;
                } else {
                    this.vx = 0;
                    this.vy = 0;
                }

                this.type = type;
                this.trail = [];
            }

            get visualRadius() {
                let factor;
                if (this.type === 'sun') {
                    factor = SUN_VISUAL_RADIUS_FACTOR;
                } else if (this.type === 'terrestrial') {
                    factor = TERRESTRIAL_VISUAL_RADIUS_FACTOR;
                } else if (this.type === 'gas_giant') {
                    factor = GAS_GIANT_VISUAL_RADIUS_FACTOR;
                } else {
                    factor = 1;
                }

                return Math.max(1, this.baseRadius * KM_TO_PIXELS_SCALE * zoom * factor);
            }

            draw() {
                const screenX = canvas.width / 2 + (this.x * KM_TO_PIXELS_SCALE - cameraX) * zoom;
                const screenY = canvas.height / 2 + (this.y * KM_TO_PIXELS_SCALE - cameraY) * zoom;
                const radius = this.visualRadius;

                if (this.name !== 'Sun') {
                    ctx.beginPath();
                    ctx.strokeStyle = `rgba(${parseInt(this.color.slice(1,3), 16)}, ${parseInt(this.color.slice(3,5), 16)}, ${parseInt(this.color.slice(5,7), 16)}, ${ORBIT_TRAIL_ALPHA})`;
                    ctx.lineWidth = ORBIT_TRAIL_WIDTH;

                    if (this.trail.length > 1) {
                        for (let i = 0; i < this.trail.length; i++) {
                            const trailPoint = this.trail[i];
                            const trailScreenX = canvas.width / 2 + (trailPoint.x * KM_TO_PIXELS_SCALE) * zoom;
                            const trailScreenY = canvas.height / 2 + (trailPoint.y * KM_TO_PIXELS_SCALE) * zoom;

                            if (i === 0) {
                                ctx.moveTo(trailScreenX, trailScreenY);
                            } else {
                                ctx.lineTo(trailScreenX, trailScreenY);
                            }
                        }
                        ctx.stroke();
                    }
                }

                const buffer = 100;
                if (screenX + radius < -buffer || screenX - radius > canvas.width + buffer ||
                    screenY + radius < -buffer || screenY > canvas.height + buffer) {
                    return;
                }

                ctx.beginPath();
                ctx.arc(screenX, screenY, radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();

                if (isCreatingNewPlanet && newPlanetData && this.name === newPlanetData.name) {
                    ctx.strokeStyle = 'cyan';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            update(gravitationalBodies) {
                let fx = 0;
                let fy = 0;

                for (const otherBody of gravitationalBodies) {
                    if (otherBody === this) continue;

                    const force = calculateGravitationalForce(this, otherBody);
                    fx += force.fx;
                    fy += force.fy;
                }

                const ax = fx / this.mass;
                const ay = fy / this.mass;

                this.vx += ax * TIME_STEP;
                this.vy += ay * TIME_STEP;

                this.x += (this.vx * TIME_STEP) / 1000;
                this.y += (this.vy * TIME_STEP) / 1000;

                if (centerBody) {
                    this.trail.push({ x: this.x - centerBody.x, y: this.y - centerBody.y });
                }

                if (this.trail.length > ORBIT_TRAIL_LENGTH) {
                    this.trail.shift();
                }
            }

            isPointInBody(pointX, pointY) {
                const screenX = canvas.width / 2 + (this.x * KM_TO_PIXELS_SCALE - cameraX) * zoom;
                const screenY = canvas.height / 2 + (this.y * KM_TO_PIXELS_SCALE - cameraY) * zoom;
                const distance = Math.sqrt(Math.pow(pointX - screenX, 2) + Math.pow(pointY - screenY, 2));
                return distance < this.visualRadius;
            }
        }

        // --- Gravitational Force Calculation ---
        function calculateGravitationalForce(body1, body2) {
            const dx = (body2.x - body1.x) * 1000;
            const dy = (body2.y - body1.y) * 1000;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance === 0) return { fx: 0, fy: 0 };

            const forceMagnitude = G * body1.mass * body2.mass / (distance * distance);

            const fx = forceMagnitude * (dx / distance);
            const fy = forceMagnitude * (dy / distance);

            return { fx, fy };
        }

        // --- Celestial Bodies Data ---
        let celestialBodies = [ // Changed to `let` to allow reassignment after deletion
            new CelestialBody('Sun', 696340, SUN_MASS, '#FFD700', 0, 0, 0, 'sun'),
            new CelestialBody('Mercury', 2439.7, 3.301e23, '#A9A9A9', 0.39, 88, Math.random() * Math.PI * 2, 'terrestrial'),
            new CelestialBody('Venus', 6051.8, 4.867e24, '#FFBF00', 0.72, 225, Math.random() * Math.PI * 2, 'terrestrial'),
            new CelestialBody('Earth', 6371, 5.972e24, '#0000FF', 1.0, 365, Math.random() * Math.PI * 2, 'terrestrial'),
            new CelestialBody('Mars', 3389.5, 6.417e23, '#FF4500', 1.52, 687, Math.random() * Math.PI * 2, 'terrestrial'),
            new CelestialBody('Jupiter', 69911, 1.898e27, '#CD853F', 5.2, 4333, Math.random() * Math.PI * 2, 'gas_giant'),
            new CelestialBody('Saturn', 58232, 5.683e26, '#DAA520', 9.58, 10759, Math.random() * Math.PI * 2, 'gas_giant'),
            new CelestialBody('Uranus', 25362, 8.681e25, '#ADD8E6', 19.22, 30687, Math.random() * Math.PI * 2, 'gas_giant'),
            new CelestialBody('Neptune', 24622, 1.024e26, '#4169E1', 30.1, 60190, Math.random() * Math.PI * 2, 'gas_giant')
        ];

        function clearAllTrails() {
            celestialBodies.forEach(body => {
                body.trail = [];
            });
        }

        centerBody = celestialBodies[0]; // Set initial center to Sun
        clearAllTrails();
        updatePlanetSelectionButtons(); // Call initially to populate buttons

        // --- Control Panel Toggle Logic ---
        function showControls() {
            controlsPanel.style.display = 'flex';
            showControlsBtn.style.display = 'none';
            hideControlsBtn.style.display = 'block';
        }

        function hideControls() {
            controlsPanel.style.display = 'none';
            showControlsBtn.style.display = 'block';
            hideControlsBtn.style.display = 'none';
        }

        showControlsBtn.addEventListener('click', showControls);
        hideControlsBtn.addEventListener('click', hideControls);

        // Initial state based on screen width
        function setInitialControlPanelVisibility() {
            if (window.innerWidth <= 768) {
                hideControls(); // Hide on mobile initially
            } else {
                showControls(); // Show on desktop initially (and hide toggle buttons via CSS)
            }
        }
        setInitialControlPanelVisibility(); // Call on load

        // Update on resize
        window.addEventListener('resize', setInitialControlPanelVisibility);


        // --- Event Listeners ---
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            setInitialControlPanelVisibility(); // Re-evaluate visibility on resize
        });

        canvas.addEventListener('wheel', (event) => {
            event.preventDefault();
            const zoomAmount = 1.1;
            if (event.deltaY < 0) {
                zoom *= zoomAmount;
            } else {
                zoom /= zoomAmount;
            }
            zoom = Math.max(0.01, Math.min(MAX_ZOOM, zoom));
        });

        canvas.addEventListener('click', (event) => {
            if (isCreatingNewPlanet && newPlanetData) {
                const mouseX = event.clientX;
                const mouseY = event.clientY;

                // Convert screen coordinates to world coordinates
                const worldX = ((mouseX - canvas.width / 2) / zoom + cameraX) / KM_TO_PIXELS_SCALE;
                const worldY = ((mouseY - canvas.height / 2) / zoom + cameraY) / KM_TO_PIXELS_SCALE;

                newPlanetData.x = worldX;
                newPlanetData.y = worldY;

                // Apply initial velocity based on user input
                const velocityMagnitude = parseFloat(initialVelocityMagnitudeInput.value) * 1000; // Convert km/s to m/s
                const velocityAngleDegrees = parseFloat(initialVelocityAngleInput.value);
                const velocityAngleRadians = velocityAngleDegrees * Math.PI / 180;

                newPlanetData.vx = velocityMagnitude * Math.cos(velocityAngleRadians);
                newPlanetData.vy = velocityMagnitude * Math.sin(velocityAngleRadians);

                const newPlanet = new CelestialBody(
                    newPlanetData.name,
                    newPlanetData.baseRadius,
                    newPlanetData.mass,
                    newPlanetData.color,
                    0, // Orbital radius is set by placement, not a fixed AU value
                    0,
                    0,
                    newPlanetData.type
                );
                newPlanet.x = newPlanetData.x;
                newPlanet.y = newPlanetData.y;
                newPlanet.vx = newPlanetData.vx;
                newPlanet.vy = newPlanetData.vy;

                celestialBodies.push(newPlanet);
                updatePlanetSelectionButtons(); // Update buttons to include the new planet

                // new planet does NOT change the centerBody by default
                // centerBody = newPlanet; // Removed this line as requested
                clearAllTrails(); // Clear trails for a fresh start

                isCreatingNewPlanet = false;
                newPlanetData = null; // Clear temporary data
                canvas.style.cursor = 'default';
                return; // Stop further click processing
            }


            const mouseX = event.clientX;
            const mouseY = event.clientY;

            for (const body of celestialBodies) {
                if (body.isPointInBody(mouseX, mouseY)) {
                    if (body !== centerBody) {
                        centerBody = body;
                        clearAllTrails();
                    }
                    break;
                }
            }
        });

        canvas.addEventListener('mousemove', (event) => {
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            let hoveredBody = null;

            for (const body of celestialBodies) {
                if (body.isPointInBody(mouseX, mouseY)) {
                    hoveredBody = body;
                    break;
                }
            }

            if (hoveredBody) {
                infoDisplay.style.display = 'block';
                infoDisplay.style.left = `${mouseX + 15}px`;
                infoDisplay.style.top = `${mouseY + 15}px`;
                infoDisplay.innerHTML = `
                    <strong>${hoveredBody.name}</strong><br>
                    Radius: ${hoveredBody.baseRadius.toLocaleString()} km<br>
                    Mass: ${hoveredBody.mass.toExponential(2)} kg<br>
                    Orbital Radius: ${hoveredBody.orbitalRadius > 0 ? (hoveredBody.orbitalRadius / AU_TO_KM).toFixed(2) + ' AU' : 'N/A'}
                `;
            } else {
                infoDisplay.style.display = 'none';
            }
        });

        // --- Touch Event Handlers ---
        canvas.addEventListener('touchstart', (event) => {
            event.preventDefault();
            infoDisplay.style.display = 'none';

            if (event.touches.length === 1) {
                isDragging = true;
                lastTouchX = event.touches[0].clientX;
                lastTouchY = event.touches[0].clientY;

                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;
                if (tapLength < DOUBLE_TAP_TIME && tapLength > 0) {
                    const touchX = event.touches[0].clientX;
                    const touchY = event.touches[0].clientY;
                    for (const body of celestialBodies) {
                        if (body.isPointInBody(touchX, touchY)) {
                            if (body !== centerBody) {
                                centerBody = body;
                                clearAllTrails();
                            }
                            break;
                        }
                    }
                }
                lastTapTime = currentTime;

            } else if (event.touches.length === 2) {
                isDragging = false;
                const touch1 = event.touches[0];
                const touch2 = event.touches[1];
                initialPinchDistance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (event) => {
            event.preventDefault();

            if (event.touches.length === 1 && isDragging) {
                const touchX = event.touches[0].clientX;
                const touchY = event.touches[0].clientY;

                const dx = touchX - lastTouchX;
                const dy = touchY - lastTouchY;

                cameraX -= dx / zoom / KM_TO_PIXELS_SCALE;
                cameraY -= dy / zoom / KM_TO_PIXELS_SCALE;

                lastTouchX = touchX;
                lastTouchY = touchY;

            } else if (event.touches.length === 2) {
                const touch1 = event.touches[0];
                const touch2 = event.touches[1];
                const currentPinchDistance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);

                if (initialPinchDistance === 0) {
                    initialPinchDistance = currentPinchDistance;
                }

                const zoomFactor = currentPinchDistance / initialPinchDistance;
                zoom *= zoomFactor;
                zoom = Math.max(0.01, Math.min(MAX_ZOOM, zoom));

                initialPinchDistance = currentPinchDistance;
            }
        }, { passive: false });

canvas.addEventListener('touchend', (event) => {
            if (event.changedTouches.length === 1) {
                const touchX = event.changedTouches[0].clientX;
                const touchY = event.changedTouches[0].clientY;
                const dx = Math.abs(touchX - lastTouchX);
                const dy = Math.abs(touchY - lastTouchY);

                // Check if it was a tap (not a drag or pinch)
                if (dx < DRAG_THRESHOLD && dy < DRAG_THRESHOLD) {
                    if (isCreatingNewPlanet && newPlanetData) {
                        // Logic to place the new planet
                        const worldX = ((touchX - canvas.width / 2) / zoom + cameraX) / KM_TO_PIXELS_SCALE;
                        const worldY = ((touchY - canvas.height / 2) / zoom + cameraY) / KM_TO_PIXELS_SCALE;

                        newPlanetData.x = worldX;
                        newPlanetData.y = worldY;

                        const velocityMagnitude = parseFloat(initialVelocityMagnitudeInput.value) * 1000;
                        const velocityAngleDegrees = parseFloat(initialVelocityAngleInput.value);
                        const velocityAngleRadians = velocityAngleDegrees * Math.PI / 180;

                        newPlanetData.vx = velocityMagnitude * Math.cos(velocityAngleRadians);
                        newPlanetData.vy = velocityMagnitude * Math.sin(velocityAngleRadians);

                        const newPlanet = new CelestialBody(
                            newPlanetData.name,
                            newPlanetData.baseRadius,
                            newPlanetData.mass,
                            newPlanetData.color,
                            0,
                            0,
                            0,
                            newPlanetData.type
                        );
                        newPlanet.x = newPlanetData.x;
                        newPlanet.y = newPlanetData.y;
                        newPlanet.vx = newPlanetData.vx;
                        newPlanet.vy = newPlanetData.vy;

                        celestialBodies.push(newPlanet);
                        updatePlanetSelectionButtons();
                        clearAllTrails();

                        isCreatingNewPlanet = false;
                        newPlanetData = null;
                        canvas.style.cursor = 'default';
                        // Hide info display if it was shown from a previous hover
                        infoDisplay.style.display = 'none';
                    } else {
                        // Original logic for selecting a body on tap
                        let tappedBody = null;
                        for (const body of celestialBodies) {
                            if (body.isPointInBody(touchX, touchY)) {
                                tappedBody = body;
                                break;
                            }
                        }
                        if (tappedBody) {
                            // If a body was tapped, center on it
                            if (tappedBody !== centerBody) {
                                centerBody = tappedBody;
                                clearAllTrails();
                            }
                            // Display info for the tapped body
                            infoDisplay.style.display = 'block';
                            infoDisplay.style.left = `${touchX + 15}px`;
                            infoDisplay.style.top = `${touchY + 15}px`;
                            infoDisplay.innerHTML = `
                                <strong>${tappedBody.name}</strong><br>
                                Radius: ${tappedBody.baseRadius.toLocaleString()} km<br>
                                Mass: ${tappedBody.mass.toExponential(2)} kg<br>
                                Orbital Radius: ${tappedBody.orbitalRadius > 0 ? (tappedBody.orbitalRadius / AU_TO_KM).toFixed(2) + ' AU' : 'N/A'}
                            `;
                        } else {
                            // If no body was tapped, hide info display
                            infoDisplay.style.display = 'none';
                        }
                    }
                }
            }

            isDragging = false;
            initialPinchDistance = 0;
            // Reset lastTapTime to prevent unintended double taps from single taps after a drag/pinch
            lastTapTime = 0;
        });


        // --- Control Buttons Logic ---

        function updatePlanetSelectionButtons() {
            planetSelectionButtonsContainer.innerHTML = ''; // Clear existing buttons

            celestialBodies.forEach(body => {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'planet-button-container';
                buttonContainer.setAttribute('data-planet-name', body.name); // Store name for easy lookup

                const button = document.createElement('button');
                button.textContent = body.name;
                button.style.backgroundColor = body.color;
                button.onclick = () => {
                    if (body !== centerBody) {
                        centerBody = body;
                        clearAllTrails();
                    }
                };
                buttonContainer.appendChild(button);

                // Add delete button for all except the Sun
                if (body.name !== 'Sun') {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'X';
                    deleteButton.className = 'delete-planet-btn';
                    deleteButton.onclick = (event) => {
                        event.stopPropagation(); // Prevent planet button click event
                        deletePlanet(body.name);
                    };
                    buttonContainer.appendChild(deleteButton);
                }
                planetSelectionButtonsContainer.appendChild(buttonContainer);
            });
        }

        function deletePlanet(planetName) {
            // Confirm with user
            if (!confirm(`Are you sure you want to delete ${planetName}?`)) {
                return;
            }

            const initialLength = celestialBodies.length;
            celestialBodies = celestialBodies.filter(body => body.name !== planetName);

            if (celestialBodies.length < initialLength) { // If a planet was actually removed
                if (centerBody && centerBody.name === planetName) {
                    centerBody = celestialBodies[0]; // Default to Sun if centered planet is deleted
                    clearAllTrails();
                }
                updatePlanetSelectionButtons(); // Re-render buttons
            }
        }

        // Initial population of planet buttons
        updatePlanetSelectionButtons();


        const speedFactors = [0.25, 0.5, 1, 2, 4, 8];
        let currentSpeedIndex = speedFactors.indexOf(1);

        function updateSpeedDisplay() {
            currentSpeedDisplay.textContent = `Speed: ${speedFactors[currentSpeedIndex]}x`;
        }

        slowDownBtn.onclick = () => {
            if (currentSpeedIndex > 0) {
                currentSpeedIndex--;
                TIME_STEP = 3600 * 24 * speedFactors[currentSpeedIndex];
                updateSpeedDisplay();
            }
        };

        speedUpBtn.onclick = () => {
            if (currentSpeedIndex < speedFactors.length - 1) {
                currentSpeedIndex++;
                TIME_STEP = 3600 * 24 * speedFactors[currentSpeedIndex];
                updateSpeedDisplay();
            }
        };

        updateSpeedDisplay();

        const radiusScaleFactors = [0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1, 1.5, 2, 3, 4, 5, 8, 10, 15, 20, 30, 50, 75, 100, 200, 500, 1000,
		   2000, 3000, 5000];

        let currentSunVisualRadiusIndex = radiusScaleFactors.indexOf(1);

        function updateSunVisualRadiusDisplay() {
            currentSunVisualRadiusScale.textContent = `Scale: ${radiusScaleFactors[currentSunVisualRadiusIndex]}x`;
        }

        decreaseSunRadiusBtn.onclick = () => {
            if (currentSunVisualRadiusIndex > 0) {
                currentSunVisualRadiusIndex--;
                SUN_VISUAL_RADIUS_FACTOR = radiusScaleFactors[currentSunVisualRadiusIndex];
                updateSunVisualRadiusDisplay();
            }
        };

        increaseSunRadiusBtn.onclick = () => {
            if (currentSunVisualRadiusIndex < radiusScaleFactors.length - 1) {
                currentSunVisualRadiusIndex++;
                SUN_VISUAL_RADIUS_FACTOR = radiusScaleFactors[currentSunVisualRadiusIndex];
                updateSunVisualRadiusDisplay();
            }
        };
        updateSunVisualRadiusDisplay();

        let currentTerrestrialVisualRadiusIndex = radiusScaleFactors.indexOf(1);

        function updateTerrestrialVisualRadiusDisplay() {
            currentTerrestrialVisualRadiusScale.textContent = `Scale: ${radiusScaleFactors[currentTerrestrialVisualRadiusIndex]}x`;
        }

        decreaseTerrestrialRadiusBtn.onclick = () => {
            if (currentTerrestrialVisualRadiusIndex > 0) {
                currentTerrestrialVisualRadiusIndex--;
                TERRESTRIAL_VISUAL_RADIUS_FACTOR = radiusScaleFactors[currentTerrestrialVisualRadiusIndex];
                updateTerrestrialVisualRadiusDisplay();
            }
        };

        increaseTerrestrialRadiusBtn.onclick = () => {
            if (currentTerrestrialVisualRadiusIndex < radiusScaleFactors.length - 1) {
                currentTerrestrialVisualRadiusIndex++;
                TERRESTRIAL_VISUAL_RADIUS_FACTOR = radiusScaleFactors[currentTerrestrialVisualRadiusIndex];
                updateTerrestrialVisualRadiusDisplay();
            }
        };
        updateTerrestrialVisualRadiusDisplay();

        let currentGasGiantVisualRadiusIndex = radiusScaleFactors.indexOf(1);

        function updateGasGiantVisualRadiusDisplay() {
            currentGasGiantVisualRadiusScale.textContent = `Scale: ${radiusScaleFactors[currentGasGiantVisualRadiusIndex]}x`;
        }

        decreaseGasGiantRadiusBtn.onclick = () => {
            if (currentGasGiantVisualRadiusIndex > 0) {
                currentGasGiantVisualRadiusIndex--;
                GAS_GIANT_VISUAL_RADIUS_FACTOR = radiusScaleFactors[currentGasGiantVisualRadiusIndex];
                updateGasGiantVisualRadiusDisplay();
            }
        };

        increaseGasGiantRadiusBtn.onclick = () => {
            if (currentGasGiantVisualRadiusIndex < radiusScaleFactors.length - 1) {
                currentGasGiantVisualRadiusIndex++;
                GAS_GIANT_VISUAL_RADIUS_FACTOR = radiusScaleFactors[currentGasGiantVisualRadiusIndex];
                updateGasGiantVisualRadiusDisplay();
            }
        };
        updateGasGiantVisualRadiusDisplay();

        // --- New Planet Creation Logic ---
        addNewPlanetBtn.addEventListener('click', () => {
            newPlanetMenu.style.display = 'flex';
            // Optionally, hide other controls while menu is open
            controlsPanel.style.display = 'none';
            // Set default values for initial velocity to Earth's orbital speed and a perpendicular angle
            initialVelocityMagnitudeInput.value = '29.78'; // Earth's average orbital speed around the Sun in km/s
            initialVelocityAngleInput.value = '90'; // Perpendicular to the initial position (relative to Sun)
        });

        createPlanetConfirmBtn.addEventListener('click', () => {
            newPlanetData = {
                name: planetNameInput.value,
                baseRadius: parseFloat(planetRadiusInput.value),
                mass: parseFloat(planetMassInput.value) * 1e24, // Convert to kg
                color: planetColorInput.value,
                type: planetTypeSelect.value,
                x: 0, // Will be set by click
                y: 0, // Will be set by click
                vx: 0, // Will be set based on user input
                vy: 0  // Will be set based on user input
            };

            newPlanetMenu.style.display = 'none';
            // Show controls again if they were hidden
            setInitialControlPanelVisibility();

            isCreatingNewPlanet = true;
            canvas.style.cursor = 'crosshair'; // Indicate placement mode
            // alert('Click anywhere on the simulation to place your new planet!'); // Removed alert
        });

        cancelNewPlanetBtn.addEventListener('click', () => {
            newPlanetMenu.style.display = 'none';
            setInitialControlPanelVisibility(); // Show controls again if they were hidden
            isCreatingNewPlanet = false;
            newPlanetData = null;
            canvas.style.cursor = 'default';
        });

        // --- Game Loop ---
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (centerBody) {
                cameraX = centerBody.x * KM_TO_PIXELS_SCALE;
                cameraY = centerBody.y * KM_TO_PIXELS_SCALE;
            } else {
                cameraX = 0;
                cameraY = 0;
            }

            for (const body of celestialBodies) {
                body.update(celestialBodies);
            }

            for (const body of celestialBodies) {
                body.draw();
            }

            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
