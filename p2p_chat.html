
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>P2P Chat</title>
<style>
body { font-family: sans-serif; padding: 20px; }
#chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
input, button { width: 100%; margin: 5px 0; padding: 5px; }
</style>
</head>
<body>

<h1>P2P Chat</h1>

<p>Ваш ID: <span id="myId">...</span></p>
<input id="connectId" placeholder="ID другого пользователя">
<button id="connectBtn">Подключиться</button>

<div id="chat"></div>
<input id="messageInput" placeholder="Введите сообщение">
<button id="sendBtn" disabled>Отправить</button>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
const myIdSpan = document.getElementById('myId');
const connectIdInput = document.getElementById('connectId');
const connectBtn = document.getElementById('connectBtn');
const chatDiv = document.getElementById('chat');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');

let conn;

// Создаём Peer с публичным PeerJS сервером
const peer = new Peer(undefined, {
  host: '0.peerjs.com',
  port: 443,
  secure: true
});

// Отображаем свой ID
peer.on('open', id => {
  myIdSpan.textContent = id;
});

// Когда к нам подключаются
peer.on('connection', connection => {
  conn = connection;
  setupConnection();
});

// Кнопка для подключения к другому пользователю
connectBtn.onclick = () => {
  const remoteId = connectIdInput.value.trim();
  if (!remoteId) return alert("Введите ID другого пользователя");
  conn = peer.connect(remoteId);
  setupConnection();
};

// Настройка соединения
function setupConnection() {
  conn.on('open', () => {
    chatDiv.innerHTML += `<p><b>Система:</b> Соединение установлено!</p>`;
    sendBtn.disabled = false;
  });

  conn.on('data', data => {
    chatDiv.innerHTML += `<p><b>Peer:</b> ${data}</p>`;
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });

  conn.on('close', () => {
    chatDiv.innerHTML += `<p><b>Система:</b> Соединение закрыто</p>`;
    sendBtn.disabled = true;
  });
}

// Отправка сообщений
sendBtn.onclick = () => {
  const msg = messageInput.value.trim();
  if (!msg || !conn || conn.open === false) return;
  conn.send(msg);
  chatDiv.innerHTML += `<p><b>Me:</b> ${msg}</p>`;
  chatDiv.scrollTop = chatDiv.scrollHeight;
  messageInput.value = '';
};
</script>

</body>
</html>
